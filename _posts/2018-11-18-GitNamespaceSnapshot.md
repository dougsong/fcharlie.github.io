---
layout: post
title:  "Git 基于名称空间的存储库快照备份方案"
date:   2018-11-18 10:00:00
published: false
categories: git
---
# 前言

[Git](https://en.wikipedia.org/wiki/Git) 是一种分布式的版本控制系统，分布式版本控制系统的一大特性就是远程存储库和本地存储库都包含存储库的完整数据。这一特性意味着通常来说用户的代码资产要比 svn 之类的集中式版本控制系统更加安全。而集中式的版本控制系统仅仅只有远程服务器包含存储库完整的数据，本地只是特定版本的 `checkout`。但是，当 `Git` 被越来越多的人使用后，Git 所面临的困难也与日俱增。为了加快存储库的获取，Git 势必增加一些措施减少存储库获取的时间，比如浅表克隆，单分支克隆等等，更进一步的有 `git-vfs` `git partial clone` 等（`git partial clone` 未发布）。当用户使用这些功能时，本地的存储库也就不再是一个完整的存储库了。开发者也不会信誓旦旦的认为 Git 绝对安全。这时候备份也就有一定的必要了。

Git 给开发者非常大的自由，git 可以修改 commit 重新提交，也可以强制推送引用到远程服务器，覆盖特定的引用，不合理的使用强制推送是非常危险的，这很容易造成代码丢失，对于企业存储库来说，合理的备份能够代码丢失后减小代码资产的损失。

存储库备份处理保证存储库的对象安全，实际上还要保证引用安全，历史（包括引用）记录可追溯。

## Gitee 目前备份方案

Gitee 的企业存储库除了使用 `Git Native Hook` +`Blaze`+`Git-Diamond` 的 `DGIT` 自动同步方案实现其高可用（当用户推送后通过钩子发送消息，由 blaze 将存储库以镜像的方式推送到 `Slave` 服务器，在发生故障时，`Slave` 服务器可以作为 `Master` 使用）。还会定期使用 `rsync` 将存储库快照备份到专门的备份服务器，使用 `rsync` 方式备份以一个平均大小为 `1GB` 的存储库来计算，90天一个周期，每 7 天备份一次，需要耗费的存储空间为 `12.9 GB`。按照尊享版 100GB 空间，使用率 `20%` 计算：

```
12.9 GB*20=258 GB
```
一百个尊享版企业就需要 `25.2TB` 存储空间，这是非常恐怖的。随着更多的用户开始使用码云企业版，我们的企业备份机器也开始存储告急，如何在技术上改进企业快照备份方案也摆在了开发人员的面前。


## 引用快照备份方案

Git 存储库的资产主要是对象和引用，对象实际上是按照哈希存储到存储库中的，在之前的备份方案中，在同一个存储库的不同备份中，存在有大量重复的对象，这些对象占用了存储空间。我们只要在不同的快照中复用这些对象即可。git 存储库中复用对象可以使用 `GIT_NAMESPACE` 隔离模拟成不同的存储库，也可以使用对象借用，


## 总结

在研究此方案时，需要对 Git 的相关技术细节非常清楚，比如，笔者在编写 `packed-refs` 时，最开始未了解到 `packed-refs` 引用是按字母排序的，直接写入导致一些引用异常，写入失败。

## 其他

1. Git 服务器并不知道用户是否是强制推送，除非开启了 `receive.denyNonFastForwards=true`，`receive-pack` 通过 commit 回溯扫描检查才能知道用户是否强制推送（这通常会减缓远程服务器的响应速度，并且与一次性推送的 commit 数目密切相关）。

2. 合理的强推有时候是必要的，比如使用强推删除涉密信息，修改提交内容，合并提交等等， 笔者在给 Git 贡献代码时就多次使用强推。 [PR: http: add support selecting http version](https://github.com/gitgitgadget/git/pull/69) 中也强推了好几次。